<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Static Content Data</title>
    <style>
      :root {
        --bg: #ececec;
        --surface: #ffffff;
        --text: #0f1723;
        --muted: #3f4a60;
        --line: #cfd5e0;
        --accent: #156bc7;
        --value-bg: #f1efd9;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .page {
        max-width: 1240px;
        margin: 0 auto;
        padding: 20px 24px 40px;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 16px;
        color: var(--text);
        text-decoration: none;
        font-weight: 700;
      }

      .header-box {
        border-top: 1px solid #ddd;
        padding-top: 18px;
        margin-bottom: 22px;
      }

      .header-box h1 {
        margin: 0 0 6px;
        font-size: 2rem;
      }

      .header-box p {
        margin: 0 0 10px;
        color: var(--muted);
      }

      .toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      button {
        border: 0;
        border-radius: 3px;
        padding: 7px 12px;
        background: var(--accent);
        color: #fff;
        font-weight: 700;
        cursor: pointer;
      }

      .status {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .section-block + .section-block {
        margin-top: 26px;
      }

      .section-block h2 {
        margin: 0 0 12px;
        font-size: 2rem;
        text-transform: capitalize;
      }

      .table-wrap {
        background: var(--surface);
        border: 1px solid var(--line);
        overflow: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
      }

      th,
      td {
        padding: 8px 9px;
        border: 1px solid var(--line);
        vertical-align: top;
        text-align: left;
        font-size: 0.9rem;
      }

      th {
        color: #fff;
        background: var(--accent);
        font-size: 0.88rem;
      }

      td.key {
        width: 19%;
        font-family: Consolas, monospace;
        font-size: 0.85rem;
      }

      td.value {
        width: 36%;
        background: var(--value-bg);
      }

      td.path {
        width: 25%;
        color: var(--muted);
        font-size: 0.85rem;
      }

      td.selector {
        width: 20%;
        font-family: Consolas, monospace;
        font-size: 0.85rem;
      }

      .selector-id {
        display: block;
        margin-bottom: 4px;
      }

      .selector-links {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        font-family: "Segoe UI", Tahoma, sans-serif;
      }

      .selector-links a {
        color: var(--accent);
        text-decoration: none;
        font-size: 0.78rem;
        font-weight: 700;
      }

      .selector-links a:hover,
      .selector-links a:focus-visible {
        text-decoration: underline;
      }

      textarea {
        width: 100%;
        min-height: 58px;
        border: 1px solid #c5c9d3;
        background: #fffdf3;
        padding: 8px;
        font: inherit;
        resize: vertical;
      }

      .empty {
        color: var(--muted);
        font-style: italic;
        border: 1px dashed var(--line);
        padding: 12px;
        background: #fafafa;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <a class="back-link" href="index.html">Back to Home</a>

      <div class="header-box">
        <h1>Static Content Data</h1>
        <p>This page displays the raw data configured in <code>content.json</code>.</p>
        <div class="toolbar">
          <button id="downloadBtn" type="button">Download JSON</button>
          <span id="rowCount" class="status">Loading...</span>
        </div>
      </div>

      <div id="sectionsContainer"></div>
    </div>

    <script>
      let contentData = null;
      let pageSelectorMap = {
        index: new Set(),
        about: new Set(),
      };

      function normalizePath(pathParts) {
        return pathParts
          .map(function (part) {
            return String(part).replace(/^\[(\d+)\]$/, "item$1");
          })
          .join(" > ");
      }

      function collectRows(node, pathParts, rows) {
        if (!node || typeof node !== "object") return;

        if (
          typeof node.selector === "string" &&
          Object.prototype.hasOwnProperty.call(node, "value")
        ) {
          rows.push({ path: pathParts.slice(), selector: node.selector, nodeRef: node });
          return;
        }

        if (Array.isArray(node)) {
          node.forEach(function (item, index) {
            collectRows(item, pathParts.concat("[" + (index + 1) + "]"), rows);
          });
          return;
        }

        Object.entries(node).forEach(function ([key, value]) {
          collectRows(value, pathParts.concat(key), rows);
        });
      }

      function renderSections(rows) {
        const container = document.getElementById("sectionsContainer");
        container.innerHTML = "";

        const bySection = {};
        rows.forEach(function (row) {
          const sectionName = row.path.length > 0 ? row.path[0] : "root";
          bySection[sectionName] = bySection[sectionName] || [];
          bySection[sectionName].push(row);
        });

        const sectionNames = Object.keys(bySection).sort();
        sectionNames.forEach(function (sectionName) {
          const block = document.createElement("section");
          block.className = "section-block";

          const heading = document.createElement("h2");
          heading.textContent = sectionName;
          block.appendChild(heading);

          const tableWrap = document.createElement("div");
          tableWrap.className = "table-wrap";
          const table = document.createElement("table");
          table.innerHTML =
            "<thead><tr><th>Key</th><th>Value</th><th>Group Path</th><th>Selector</th></tr></thead>";
          const tbody = document.createElement("tbody");

          bySection[sectionName].forEach(function (row) {
            const tr = document.createElement("tr");
            const keyTd = document.createElement("td");
            keyTd.className = "key";
            keyTd.textContent = row.path[row.path.length - 1] || "";

            const valueTd = document.createElement("td");
            valueTd.className = "value";
            const textarea = document.createElement("textarea");
            textarea.value = String(row.nodeRef.value ?? "");
            textarea.addEventListener("input", function () {
              row.nodeRef.value = textarea.value;
            });
            valueTd.appendChild(textarea);

            const pathTd = document.createElement("td");
            pathTd.className = "path";
            pathTd.textContent = normalizePath(row.path);

            const selectorTd = document.createElement("td");
            selectorTd.className = "selector";
            const idText = document.createElement("span");
            idText.className = "selector-id";
            idText.textContent = row.selector;
            selectorTd.appendChild(idText);

            const selectorId = String(row.selector || "").replace(/^#/, "");
            const linksWrap = document.createElement("div");
            linksWrap.className = "selector-links";

            if (pageSelectorMap.index.has(selectorId)) {
              const indexLink = document.createElement("a");
              indexLink.href = "index.html#" + selectorId;
              indexLink.target = "_blank";
              indexLink.rel = "noopener noreferrer";
              indexLink.textContent = "Open in Home";
              linksWrap.appendChild(indexLink);
            }

            if (pageSelectorMap.about.has(selectorId)) {
              const aboutLink = document.createElement("a");
              aboutLink.href = "about.html#" + selectorId;
              aboutLink.target = "_blank";
              aboutLink.rel = "noopener noreferrer";
              aboutLink.textContent = "Open in About";
              linksWrap.appendChild(aboutLink);
            }

            if (!linksWrap.children.length) {
              const none = document.createElement("span");
              none.style.color = "var(--muted)";
              none.style.fontSize = "0.78rem";
              none.textContent = "No page match";
              linksWrap.appendChild(none);
            }

            selectorTd.appendChild(linksWrap);

            tr.appendChild(keyTd);
            tr.appendChild(valueTd);
            tr.appendChild(pathTd);
            tr.appendChild(selectorTd);
            tbody.appendChild(tr);
          });

          table.appendChild(tbody);
          tableWrap.appendChild(table);
          block.appendChild(tableWrap);
          container.appendChild(block);
        });

        if (sectionNames.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "No content entries found.";
          container.appendChild(empty);
        }

        document.getElementById("rowCount").textContent =
          rows.length + " content entries";
      }

      function getIdSetFromHtml(htmlText) {
        const doc = new DOMParser().parseFromString(htmlText, "text/html");
        const ids = new Set();
        doc.querySelectorAll("[id]").forEach(function (el) {
          ids.add(el.id);
        });
        return ids;
      }

      function downloadJson() {
        if (!contentData) return;

        const jsonText = JSON.stringify(contentData, null, 2);
        const blob = new Blob([jsonText], { type: "application/json" });
        const objectUrl = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = objectUrl;
        link.download = "content.json";
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(objectUrl);
      }

      async function init() {
        try {
          const responses = await Promise.all([
            fetch("content.json", { cache: "no-store" }),
            fetch("index.html", { cache: "no-store" }),
            fetch("about.html", { cache: "no-store" }),
          ]);

          if (!responses[0].ok) throw new Error("Could not load content.json");

          contentData = await responses[0].json();

          const indexHtml = responses[1].ok ? await responses[1].text() : "";
          const aboutHtml = responses[2].ok ? await responses[2].text() : "";
          pageSelectorMap.index = getIdSetFromHtml(indexHtml);
          pageSelectorMap.about = getIdSetFromHtml(aboutHtml);

          const rows = [];
          collectRows(contentData, [], rows);
          renderSections(rows);
        } catch (error) {
          document.getElementById("rowCount").textContent =
            "Failed to load content.json";
          console.error(error);
        }
      }

      document
        .getElementById("downloadBtn")
        .addEventListener("click", downloadJson);

      init();
    </script>
  </body>
</html>
